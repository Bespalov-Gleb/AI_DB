# План работ (8 дней) по системе ИИ-управления БД

Исходные изменения к ТЗ: используем ChatGPT (OpenAI API) вместо YandexGPT; базу данных поднимаем самостоятельно (PostgreSQL в Docker), без управляемой YDB. Прочее из ТЗ сохраняется: Telegram-бот как основной интерфейс, простой веб-интерфейс, хранение фотографий в S3-совместимом хранилище (например, Yandex Object Storage), автоматические отчеты/копии, самодиагностика, напоминания и ограничения доступа.

## Стек и базовые решения
- **Язык и фреймворк**: Python 3.11, FastAPI.
- **Бот**: `aiogram` 3.x (или `python-telegram-bot` 21.x).
- **ИИ**: OpenAI Chat Completions / Responses API (ChatGPT, gpt-4o-mini / gpt-4.1) через официальную библиотеку.
- **База данных**: PostgreSQL 15 (Docker Compose), ORM — SQLAlchemy 2.x, миграции — Alembic.
- **Планировщик**: APScheduler (cron-задачи).
- **Отчеты/Excel**: pandas + openpyxl, отправка писем — SMTP (например, Mail.ru/Yandex/корп. SMTP).
- **Хранилище фото**: S3-совместимое (Yandex Object Storage), SDK — `boto3`.
- **Веб-интерфейс**: FastAPI + Jinja2 (минимальный, для просмотра и фильтров).
- **Логирование**: стандартный `logging` или `structlog`.
- **Аутентификация/доступ**: роль «владелец» + список доп. пользователей с ограничениями срока и прав.

## Схема БД (высокий уровень)
- `users`: пользователи/доступ (id, имя, tg_id, роли, срок доступа, создано/обновлено).
- `listings`: записи спрос/предложение/договор (типы, наименование, описание, характеристики JSONB, количество, цена, местонахождение, контакты, ссылки на фото, статус, таймстемпы).
- `photos`: связи запись↔файлы в S3 (listing_id, s3_key, url, размер, hash, создано).
- `reminders`: напоминания (текст, время с таймзоной, связанный пользователь/контакт, статус).
- `audit_log`: журнал действий (кто, что, когда, payload, результат).

Примечание: телефоны нормализуем к E.164; характеристики — JSONB для гибкости фильтрации.

---

## График на 8 дней

### День 1 — Архитектура и подготовка окружения
- Уточнение рабочих допущений (таймзона, SMTP, домен отправителя, формат Excel).
- Проект: репозиторий, базовая структура, Docker Compose (PostgreSQL + pgadmin при необходимости).
- Базовая конфигурация (`.env`): OPENAI_API_KEY, TELEGRAM_BOT_TOKEN, SMTP, S3.
- Проработка ER-диаграммы и первичного набора таблиц; черновик Alembic-миграций.
- Документ с командами/ролями бота и пользовательскими сценариями.

### День 2 — Бэкенд-сервис и БД
- FastAPI скелет, конфиг, зависимость к БД (SQLAlchemy), миграции Alembic.
- Реализация моделей: `users`, `listings`, `photos`, `reminders`, `audit_log`.
- Утилиты: нормализация телефонов, валидация контактов, общие исключения.
- Базовый аудит: запись событий CRUD в `audit_log`.
- Юнит-тесты для слоя данных.

### День 3 — Интеграция ChatGPT и парсинг сообщений
- Сервис классификации: определение типа (продажа/спрос/договор) по тексту.
- Сервис парсинга: извлечение полей из неструктурированного текста в Pydantic-модель.
- Промпты: проектирование, версияция, анти-халлюцинации (инструкции, формат JSON, валидации).
- Фолбэк-валидация: проверки обязательных полей, просьба о доуточнении через бот.
- Тесты на парсинг и классификацию, ограничение токенов/стоимости.

### День 4 — Telegram-бот и поток добавления записей/фото
- Диалоги добавления/редактирования/удаления записей с подтверждениями.
- Обработка фотографий: загрузка в S3, связь с записью, хранение ссылок.
- Команды экспорта по фильтрам в Excel и отправка файла в Telegram.
- Ограничение доступа: владелец/гости, срок, базовые ACL на команды.
- Формальный стиль ответов, локализация сообщений.

### День 5 — Поиск совпадений и планировщик задач
- Алгоритм сопоставления «Спрос↔Предложение»: поля, веса, нормализация строк.
- Задача на 09:00 ежедневно: формирование и отправка таблицы совпадений в Telegram.
- Задача на пятницу 17:00: полная выгрузка БД в Excel и отправка на email.
- Конфигурирование APScheduler, устойчивость при рестартах (job store).

### День 6 — Статистика и напоминания
- Еженедельная статистика (понедельник 09:00): кол-во заявок, популярные товары, регионы.
- Механизм напоминаний: создание через команду, хранение, отправка в нужное время.
- Интеграция с календарем (опционально): Google/Yandex через токены; фолбэк — внутренний планировщик.
- Тесты и верификация расписаний.

### День 7 — Самодиагностика и журнал
- Задача на среду 18:00: дубликаты, пустые поля, формат телефона, битые фото-ссылки, доступность S3/SMTP.
- Отчеты о проблемах в Telegram + запись в `audit_log`.
- Команды в боте: выгрузка журнала действий (Excel/текст), фильтры по периоду и типу.
- Хардненинг логирования, маскирование секретов, ретраи на внешние сервисы.

### День 8 — Веб-интерфейс, безопасность и документация
- Мини-веб (FastAPI + Jinja2): список/фильтры записей, пагинация, просмотр деталей.
- Авторизация в веб-интерфейсе, простая ролевая модель.
- Полировка UX в боте, финальные тесты и нагрузочная проверка ключевых маршрутов.
- Документация: команды Telegram, админ-гайд, эксплуатация и резервное копирование.
- Буфер на риски и стабилизацию.

---

## Требуемые доступы/секреты
- OpenAI API Key.
- Telegram Bot Token.
- SMTP (логин/пароль, адрес отправителя, список получателей).
- S3 (endpoint, access key, secret, bucket, регион).
- (Опционально) Google/Yandex Calendar OAuth/сервисный аккаунт.

## Критерии приемки (минимум)
- Бот принимает текст/фото, корректно парсит, сохраняет запись и фото-ссылки.
- Ежедневная рассылка совпадений в 09:00 в Telegram.
- Пятничная выгрузка всей БД в Excel на email в 17:00.
- Понедельничная статистика в 09:00 на email (или в Telegram, по настройке).
- Средовая самодиагностика в 18:00 с отчётом в Telegram.
- Редактирование/удаление записей по командам, экспорт по фильтрам в Excel.
- Журнал действий доступен по запросу.
- Простой веб-интерфейс для просмотра/фильтрации записей.

## Риски и пометки
- Нужны своевременные ключи/доступы — без них сроки сдвигаются.
- Точность парсинга зависит от качества входящих формулировок; предусмотрены диалоги уточнений.
- Если интеграция календарей не критична к Д8 — оставить на постплан.

## Итоги
К концу 8-го дня доступен работающий Telegram-бот с формальным стилем, бэкенд с собственной БД PostgreSQL, планировщик задач с отчётами/копиями, самодиагностика, базовый веб-интерфейс и документация. ИИ-обработка реализована на ChatGPT (OpenAI API).

