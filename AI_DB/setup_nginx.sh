#!/bin/bash

# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Nginx Ð´Ð»Ñ AI_DB
echo "ðŸ”§ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Nginx..."

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ Nginx
cat > /etc/nginx/sites-available/ai-db.ru << 'EOF'
server {
    listen 80;
    server_name ai-db.ru www.ai-db.ru;
    
    # Ð›Ð¾Ð³Ð¸
    access_log /var/log/nginx/ai-db.ru.access.log;
    error_log /var/log/nginx/ai-db.ru.error.log;
    
    # ÐŸÑ€Ð¾ÐºÑÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð½Ð° Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ
    location / {
        proxy_pass http://localhost:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Ð¢Ð°Ð¹Ð¼Ð°ÑƒÑ‚Ñ‹
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # Ð¡Ñ‚Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
    location /static/ {
        alias /root/AI_DB/uploads/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # Ð—Ð´Ð¾Ñ€Ð¾Ð²ÑŒÐµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
    location /health {
        proxy_pass http://localhost:8000/health;
        access_log off;
    }
}
EOF

# ÐÐºÑ‚Ð¸Ð²Ð¸Ñ€ÑƒÐµÐ¼ ÑÐ°Ð¹Ñ‚
ln -sf /etc/nginx/sites-available/ai-db.ru /etc/nginx/sites-enabled/

# Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð´ÐµÑ„Ð¾Ð»Ñ‚Ð½ÑƒÑŽ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ
rm -f /etc/nginx/sites-enabled/default

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ
nginx -t

if [ $? -eq 0 ]; then
    echo "âœ… ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Nginx ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð°"
    systemctl reload nginx
    echo "âœ… Nginx Ð¿ÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½"
else
    echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð² ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Nginx"
    exit 1
fi 